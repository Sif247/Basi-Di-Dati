

SET NOCOUNT ON
SET DATEFORMAT dmy

USE master
go

IF EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = 'DB20230616')  
	DROP DATABASE DB20230616
GO

CREATE database DB20230616
GO
USE DB20230616
GO


CREATE TABLE [INSEGNAMENTO](
	[NOME_INSEGNAMENTO] [nvarchar](50) NOT NULL,
	[CDL] [int] NOT NULL,
	[DOCENTE] [nvarchar](50) NOT NULL,
	[ANNO_CORSO] [nvarchar](50) NOT NULL,
PRIMARY KEY (	[NOME_INSEGNAMENTO] , [CDL])
)
GO
CREATE TABLE [APPELLO](
	[ID_APPELLO] [int] NOT NULL PRIMARY KEY ,
	[SESSIONE] [nvarchar](100) NOT NULL,
	[NOME_INSEGNAMENTO] [nvarchar](50) NULL,
	[CDL_INSEGNAMENTO] [int] NULL,
	FOREIGN KEY([NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) REFERENCES [INSEGNAMENTO]
)
GO

CREATE TABLE [STUDENTE](
	[MATRICOLA] [int] NOT NULL PRIMARY KEY ,
	[NOME] [nvarchar](100) NOT NULL,
	[COGNOME] [nvarchar](100) NOT NULL,
	[NAZIONESTUDENTE] [nvarchar](200) NULL)

CREATE TABLE [SOSTIENE](
	[MATRICOLA] [int] NOT NULL REFERENCES STUDENTE,
	[ID_APPELLO] [int] NOT NULL REFERENCES APPELLO,
PRIMARY KEY (	[MATRICOLA] , 	[ID_APPELLO] )
)


INSERT [INSEGNAMENTO] ([NOME_INSEGNAMENTO], [CDL], [DOCENTE], [ANNO_CORSO]) VALUES (N'ANALISI', 2020, N'Rossi', N'Primo')
GO
INSERT [INSEGNAMENTO] ([NOME_INSEGNAMENTO], [CDL], [DOCENTE], [ANNO_CORSO]) VALUES (N'ANALISI', 2021, N'Rossi', N'Secondo')
GO
INSERT [INSEGNAMENTO] ([NOME_INSEGNAMENTO], [CDL], [DOCENTE], [ANNO_CORSO]) VALUES (N'ANALISI', 2022, N'Verdi', N'Terzo')
GO
INSERT [INSEGNAMENTO] ([NOME_INSEGNAMENTO], [CDL], [DOCENTE], [ANNO_CORSO]) VALUES (N'FISICA', 2021, N'Chiari', N'Primo')
GO
INSERT [INSEGNAMENTO] ([NOME_INSEGNAMENTO], [CDL], [DOCENTE], [ANNO_CORSO]) VALUES (N'FISICA', 2022, N'Verdi', N'Terzo')
GO

GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (100, N'Estiva2010', N'ANALISI', 2020)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (101, N'Estiva2010', N'ANALISI', 2020)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (102, N'Estiva2010', N'ANALISI', 2020)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (103, N'Invernale2010', N'ANALISI', 2020)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (105, N'Invernale2011', N'ANALISI', 2020)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (110, N'Invernale2010', N'ANALISI', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (111, N'Invernale2011', N'ANALISI', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (112, N'Invernale2011', N'ANALISI', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (120, N'Invernale2010', N'ANALISI', 2022)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (121, N'Invernale2011', N'ANALISI', 2022)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (130, N'Invernale2010', N'FISICA', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (131, N'Invernale2009', N'FISICA', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (132, N'Speciale2010', N'FISICA', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (133, N'Speciale2011', N'FISICA', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (134, N'Speciale2010', N'FISICA', 2021)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (140, N'Estiva2011', N'FISICA', 2022)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (141, N'Estiva2011', N'FISICA', 2022)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (142, N'Speciale2011', N'FISICA', 2022)
GO
INSERT [APPELLO] ([ID_APPELLO], [SESSIONE], [NOME_INSEGNAMENTO], [CDL_INSEGNAMENTO]) VALUES (143, N'Estiva2011', N'FISICA', 2022)
GO

INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (1, N'Anhoi', N'James', N'USA')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (2, N'Kelly', N'Clarkson', N'USA')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (3, N'Rey', N'Yong', N'Italy')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (4, N'David', N'Jonson', N'HongKong')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (5, N'Leona', N'Water', N'USA')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (6, N'Mattiew', N'Yegii', N'USA')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (7, N'Veronica', N'Rozzi', N'Italy')
GO
INSERT [STUDENTE] ([MATRICOLA], [NOME], [COGNOME], [NAZIONESTUDENTE]) VALUES (8, N'John', N'White', N'China')
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (1, 100)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (1, 111)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (1, 130)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (1, 141)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (2, 100)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (2, 111)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (2, 132)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (2, 141)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 101)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 112)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 120)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 130)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 131)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (3, 133)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 101)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 112)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 120)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 130)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 131)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (4, 133)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (5, 102)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (5, 105)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (5, 134)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (5, 142)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (5, 143)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (6, 103)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (6, 121)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (6, 134)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (7, 132)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (7, 140)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (8, 110)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (8, 132)
GO
INSERT [SOSTIENE] ([MATRICOLA], [ID_APPELLO]) VALUES (8, 140)
GO


--ESERCIZIO 1

SELECT A.NOME_INSEGNAMENTO, A.CDL_INSEGNAMENTO, A.ID_APPELLO, A.SESSIONE
FROM APPELLO A, INSEGNAMENTO I, SOSTIENE S, STUDENTE ST
WHERE A.CDL_INSEGNAMENTO = I.CDL
AND A.NOME_INSEGNAMENTO = I.NOME_INSEGNAMENTO
AND A.ID_APPELLO = S.ID_APPELLO
AND ST.MATRICOLA = S.MATRICOLA
AND ST.NAZIONESTUDENTE = 'China'
AND I.ANNO_CORSO = N'Primo';

--ESERCIZIO 2


SELECT DISTINCT I.NOME_INSEGNAMENTO, I.CDL, I.DOCENTE, I.ANNO_CORSO
FROM APPELLO A, INSEGNAMENTO I, SOSTIENE S, STUDENTE ST
WHERE A.CDL_INSEGNAMENTO = I.CDL
AND A.NOME_INSEGNAMENTO = I.NOME_INSEGNAMENTO
AND A.ID_APPELLO = S.ID_APPELLO
AND ST.MATRICOLA = S.MATRICOLA
AND ST.NAZIONESTUDENTE = 'China'
OR ST.NAZIONESTUDENTE = 'USA'


--ESERCIZIO 3

SELECT S.MATRICOLA, I.DOCENTE, COUNT(A.ID_APPELLO) AS N_APPELLI
FROM SOSTIENE S, APPELLO A, INSEGNAMENTO I
WHERE S.ID_APPELLO = A.ID_APPELLO
AND A.NOME_INSEGNAMENTO = I.NOME_INSEGNAMENTO 
AND I.CDL = A.CDL_INSEGNAMENTO
AND I.ANNO_CORSO = 'Terzo'
GROUP BY S.MATRICOLA, I.DOCENTE
HAVING COUNT(*) >= ALL(SELECT COUNT(*)
					   FROM SOSTIENE S1, APPELLO A1, INSEGNAMENTO I1
					   WHERE S1.ID_APPELLO = A1.ID_APPELLO
					   AND A1.NOME_INSEGNAMENTO = I1.NOME_INSEGNAMENTO 
					   AND I1.CDL = A1.CDL_INSEGNAMENTO
					   AND I1.ANNO_CORSO = 'Terzo'
					   AND S.MATRICOLA < S1.MATRICOLA
					   GROUP BY DOCENTE, MATRICOLA);



--ESERCIZIO 4

SELECT DISTINCT I.DOCENTE
FROM INSEGNAMENTO I
WHERE I.DOCENTE NOT IN (SELECT I2.DOCENTE
						FROM INSEGNAMENTO I2, APPELLO A, SOSTIENE S, STUDENTE ST
						WHERE I2.CDL = A.CDL_INSEGNAMENTO
						AND A.NOME_INSEGNAMENTO = I2.NOME_INSEGNAMENTO
						AND A.SESSIONE = 'Invernale2010'
						AND A.ID_APPELLO = S.ID_APPELLO
						AND ST.MATRICOLA = S.MATRICOLA
						AND ST.NAZIONESTUDENTE = 'USA');

