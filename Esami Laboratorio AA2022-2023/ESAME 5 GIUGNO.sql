SET NOCOUNT ON
SET DATEFORMAT dmy

USE master
GO

IF EXISTS (SELECT name FROM dbo.sysdatabases WHERE name = 'DB_2022_01_14')  
	DROP DATABASE [DB_2022_01_14]
GO

CREATE database [DB_2022_01_14]
GO
USE [DB_2022_01_14]
GO

/*
Creo gli script delle tabelle
*/
CREATE TABLE SOCIETA(
COD_S [nvarchar] (50) NOT NULL PRIMARY KEY,
NOME [nvarchar] (50) NOT NULL,
TOT_KM [INT]
)
GO

CREATE TABLE TRATTA(
COD_T [nvarchar] (50) NOT NULL PRIMARY KEY,
CITTA_PARTENZA [nvarchar] (50) NOT NULL,
CITTA_ARRIVO [nvarchar] (50) NOT NULL,
SOC_COMPETENZA [nvarchar] (50) NOT NULL,
PEDAGGIO [INT] NOT NULL,
FOREIGN KEY(SOC_COMPETENZA) REFERENCES SOCIETA
)
GO

 CREATE TABLE AUTOMOBILISTA(
 COD_F [nvarchar] (20) PRIMARY KEY,
 ETA  [INT] NOT NULL,
 COGNOME [nvarchar] (20),
 NOME [nvarchar] (20),
 SESSO [nvarchar] (1) NOT NULL
 )
 GO

CREATE TABLE VIAGGIO(
COD_V [int] IDENTITY PRIMARY KEY,
AUTOMOBILISTA [nvarchar] (20) NOT NULL,
TRATTA [nvarchar] (50) NOT NULL,
DURATA [INT] NOT NULL,
FOREIGN KEY(AUTOMOBILISTA) REFERENCES AUTOMOBILISTA,
FOREIGN KEY(TRATTA) REFERENCES TRATTA)
GO

INSERT INTO SOCIETA VALUES('ANAS','Anas S.p.A',953)
INSERT INTO SOCIETA VALUES('AI','Autostrade italia',2855)
INSERT INTO SOCIETA VALUES('AB','Autostrada del Brennero',314)
INSERT INTO SOCIETA VALUES('CAS','Consorzio per le Autostrade Siciliane',298)

INSERT INTO TRATTA VALUES('1n','Roma','Milano','ANAS',42)
INSERT INTO TRATTA VALUES('1s','Milano','Roma','ANAS',42)
INSERT INTO TRATTA VALUES('2n','Milano','Torino','AI',17)
INSERT INTO TRATTA VALUES('2s','Torino','Milano','AI',17)
INSERT INTO TRATTA VALUES('3n','Napoli','Firenze','AI',30)
INSERT INTO TRATTA VALUES('3s','Firenze','Napoli','AI',30)
INSERT INTO TRATTA VALUES('4n','Palermo','Messina','CAS',26)
INSERT INTO TRATTA VALUES('4s','Messina','Palermo','CAS',26)
INSERT INTO TRATTA VALUES('5n','Modena','Trento','AB',15)
INSERT INTO TRATTA VALUES('5s','Trento','Modena','AB',15)
INSERT INTO TRATTA VALUES('6n','Mantova','Verona','AB',5)
INSERT INTO TRATTA VALUES('6s','Verona','Mantova','AB',5)

INSERT INTO AUTOMOBILISTA VALUES('BRBMDE02T09G273Z',30,'Barbieri','Amedeo','M')
INSERT INTO AUTOMOBILISTA VALUES('CSDGNY05P63L219K',25,'Casadei','Geany','F')
INSERT INTO AUTOMOBILISTA VALUES('NPLTDR02L06L736U',55,'Napoleone','Teodoro','M')
INSERT INTO AUTOMOBILISTA VALUES('CSNJPH09H62D969V',67,'Cesena','Jacopa','F')
INSERT INTO AUTOMOBILISTA VALUES('NTNVLN08H60D612Y',57,'Netani','Valeria','F')
INSERT INTO AUTOMOBILISTA VALUES('RSSMRA09A01F240G',40,'Rossi','Mario','M')
INSERT INTO AUTOMOBILISTA VALUES('RSSMCL04H12F257W',19,'Rossi','Michela','F')
INSERT INTO AUTOMOBILISTA VALUES('CRRLNE08T45D969A',34,'Corradi','Leona','F')
INSERT INTO AUTOMOBILISTA VALUES('NREPLA17L41H199N',29,'Nereo','Paola','F')

INSERT INTO VIAGGIO VALUES('CSNJPH09H62D969V','1s',4)
INSERT INTO VIAGGIO VALUES('CSDGNY05P63L219K','1n',5)
INSERT INTO VIAGGIO VALUES('NPLTDR02L06L736U','2s',2)
INSERT INTO VIAGGIO VALUES('CSNJPH09H62D969V','2s',3)
INSERT INTO VIAGGIO VALUES('NTNVLN08H60D612Y','2n',2)
INSERT INTO VIAGGIO VALUES('RSSMRA09A01F240G','3s',4)
INSERT INTO VIAGGIO VALUES('RSSMCL04H12F257W','3s',3)
INSERT INTO VIAGGIO VALUES('CRRLNE08T45D969A','3n',4)
INSERT INTO VIAGGIO VALUES('NREPLA17L41H199N','2s',4)
INSERT INTO VIAGGIO VALUES('NPLTDR02L06L736U','4s',1)
INSERT INTO VIAGGIO VALUES('BRBMDE02T09G273Z','4s',2)
INSERT INTO VIAGGIO VALUES('RSSMCL04H12F257W','4n',2)
INSERT INTO VIAGGIO VALUES('RSSMRA09A01F240G','4n',3)
INSERT INTO VIAGGIO VALUES('NPLTDR02L06L736U','5s',3)
INSERT INTO VIAGGIO VALUES('RSSMRA09A01F240G','5s',2)
INSERT INTO VIAGGIO VALUES('RSSMCL04H12F257W','5n',4)
INSERT INTO VIAGGIO VALUES('CSDGNY05P63L219K','6s',2)
INSERT INTO VIAGGIO VALUES('NTNVLN08H60D612Y','6s',1)
INSERT INTO VIAGGIO VALUES('CSDGNY05P63L219K','6n',1)
INSERT INTO VIAGGIO VALUES('NREPLA17L41H199N','1s',6)
INSERT INTO VIAGGIO VALUES('NREPLA17L41H199N','1n',4)
INSERT INTO VIAGGIO VALUES('BRBMDE02T09G273Z','1s',5)
INSERT INTO VIAGGIO VALUES('CSDGNY05P63L219K','5n',4)
INSERT INTO VIAGGIO VALUES('RSSMRA09A01F240G','1s',2)
INSERT INTO VIAGGIO VALUES('RSSMCL04H12F257W','1n',4)
INSERT INTO VIAGGIO VALUES('BRBMDE02T09G273Z','4n',2)



--ESERCIZIO 1
--Seleziona i viaggi svolti da 'Amedeo Barbieri' oppure con una tratta che parte da 'Roma' di competenza della società con nome 'Anas S.p.A'

SELECT V.COD_V, V.AUTOMOBILISTA, V.DURATA, V.TRATTA
FROM VIAGGIO V, AUTOMOBILISTA A
WHERE V.AUTOMOBILISTA = A.COD_F
AND A.NOME = 'Amadeo'
AND A.COGNOME = 'Barbieri'

UNION

SELECT V.COD_V, V.AUTOMOBILISTA, V.DURATA, V.TRATTA
FROM VIAGGIO V, TRATTA T, SOCIETA S
WHERE V.TRATTA = T.COD_T
AND T.SOC_COMPETENZA = S.COD_S
AND T.CITTA_PARTENZA = 'Roma'
AND S.NOME = 'Anas S.p.A';

--ESERCIZIO 2
--Seleziona le tratte sulle quali non ha mai viaggiato un automobilista di sesso maschile

SELECT *
FROM TRATTA T
WHERE T.COD_T NOT IN(SELECT T2.COD_T
					 FROM TRATTA T2, VIAGGIO V, AUTOMOBILISTA A
					 WHERE T2.COD_T = V.TRATTA
					 AND V.AUTOMOBILISTA = A.COD_F
					 AND SESSO = 'M');


--ESERCIZIO 3
--Selezionare, per ogni compagnia autostradale, il codice, il nome e l'incasso complessivo
--(inteso come somma dei pedaggi di tutte le tratte di sua competenza per tutti i viaggi effettuati),
--limitatamente ai viaggi fatti da automobilisti con almeno due viaggi


SELECT S.COD_S, S.NOME, SUM(T.PEDAGGIO) AS INCASSO
FROM SOCIETA S, TRATTA T, AUTOMOBILISTA A, VIAGGIO V
WHERE S.COD_S = T.COD_T
AND T.COD_T = V.TRATTA
AND A.COD_F IN ( SELECT V2.AUTOMOBILISTA
				 FROM VIAGGIO V2
				 GROUP BY AUTOMOBILISTA
				 HAVING COUNT(*) >= 2)
GROUP BY S.COD_S, S.NOME;

--ESERCIZIO 4
--Trova per ogni automobilistà qual'è la società autostradale di cui ha percorso più tratte nei suoi viaggi

SELECT A.COD_F, S.COD_S, COUNT(T.COD_T) AS NUMERO_TRATTE
FROM AUTOMOBILISTA A, VIAGGIO V, TRATTA T, SOCIETA S
WHERE A.COD_F = V.AUTOMOBILISTA
AND V.TRATTA = T.COD_T
AND T.SOC_COMPETENZA = S.COD_S
GROUP BY A.COD_F, S.COD_S
HAVING COUNT(T.COD_T) >= ALL (SELECT COUNT(S2.COD_S)
							  FROM AUTOMOBILISTA A2, VIAGGIO V2, TRATTA T2, SOCIETA S2
                              WHERE A2.COD_F = V2.AUTOMOBILISTA
                              AND V2.TRATTA = T2.COD_T
                              AND T2.SOC_COMPETENZA = S2.COD_S
                              GROUP BY A2.COD_F, S2.COD_S)


--ESERCIZIO 5
--Seleziona gli automobilisti che hanno percorso almeno una tratta di ogni società autostradale (Suggerimento: si vogliono gli utenti che siano in relazione con tutte le società)

SELECT V.AUTOMOBILISTA
FROM VIAGGIO V
WHERE NOT EXISTS (SELECT S.COD_S
				  FROM SOCIETA S
				  WHERE NOT EXISTS (SELECT COD_T
									FROM TRATTA T
									WHERE T.SOC_COMPETENZA = S.COD_S
									AND T.COD_T = V.TRATTA));

