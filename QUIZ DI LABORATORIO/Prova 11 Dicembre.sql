CREATE TABLE [dbo].[AUTORE](
    [NOME] [varchar](20) NOT NULL,
    [COGNOME] [varchar](20) NOT NULL,
    [CITTA] [char](2) NULL,
    PRIMARY KEY ([NOME], [COGNOME])
);

CREATE TABLE [dbo].[LIBRO](
    [ISBN] [char](13) NOT NULL,
    [TITOLO] [varchar](50) NOT NULL,
    [CITTA] [char](2) NULL,
    [ANNO_PUBBLICAZIONE] [int] NOT NULL,
    PRIMARY KEY ([ISBN])
);

CREATE TABLE [dbo].[PRESTITO](
    [NumeroPrestito] [int] NOT NULL,
    [ISBN] [char](13) NULL,
    [UTENTE] [varchar](20) NULL,
    PRIMARY KEY ([NumeroPrestito])
);

CREATE TABLE [dbo].[SCRIVE](
    [ISBN] [char](13) NOT NULL,
    [NOME_AUTORE] [varchar](20) NOT NULL,
    [COGNOME_AUTORE] [varchar](20) NOT NULL,
    PRIMARY KEY ([ISBN], [NOME_AUTORE], [COGNOME_AUTORE]),
    FOREIGN KEY ([ISBN]) REFERENCES [dbo].[LIBRO]([ISBN]),
    FOREIGN KEY ([NOME_AUTORE], [COGNOME_AUTORE]) REFERENCES [dbo].[AUTORE]([NOME], [COGNOME])
);


INSERT INTO AUTORE (NOME, COGNOME, CITTA) VALUES ('MARIO', 'ROSSI', 'RM');
INSERT INTO AUTORE (NOME, COGNOME, CITTA) VALUES ('SIMONA', 'BIANCHI', 'NA');
INSERT INTO AUTORE (NOME, COGNOME, CITTA) VALUES ('LUCA', 'VERDI', 'MI');
INSERT INTO AUTORE (NOME, COGNOME, CITTA) VALUES ('GIANLUCA', 'ROSSI', 'MI');


INSERT INTO LIBRO VALUES ('L1', 'IL CODICE', 'RM', 2010);
INSERT INTO LIBRO VALUES ('L2', 'LA PROGRAMMAZIONE', 'NA', 2015);
INSERT INTO LIBRO VALUES ('L3', 'I DATABASE', 'TO', 2022);
INSERT INTO LIBRO VALUES ('L4', 'LA RICERCA', 'NA', 2020);
INSERT INTO LIBRO VALUES ('L5', 'IL RITORNO', 'RM', 2012);
INSERT INTO LIBRO VALUES ('L6', 'URBANO', 'RM', 2012);

INSERT INTO SCRIVE VALUES ('L1', 'MARIO', 'ROSSI');
INSERT INTO SCRIVE VALUES ('L1', 'SIMONA', 'BIANCHI');
INSERT INTO SCRIVE VALUES ('L2', 'LUCA', 'VERDI');
INSERT INTO SCRIVE VALUES ('L2', 'MARIO', 'ROSSI');
INSERT INTO SCRIVE VALUES ('L3', 'GIANLUCA', 'ROSSI');
INSERT INTO SCRIVE VALUES ('L4', 'LUCA', 'VERDI');
INSERT INTO SCRIVE VALUES ('L3', 'LUCA', 'VERDI');


INSERT INTO PRESTITO VALUES (1, 'L1', 'Mario_Rossi');
INSERT INTO PRESTITO VALUES (2, 'L1', 'Luca_Bianchi');
INSERT INTO PRESTITO VALUES (3, 'L3', 'Anna_Verdi');
INSERT INTO PRESTITO VALUES (4, 'L3', 'Mario_Rossi');
INSERT INTO PRESTITO VALUES (5, 'L5', 'Giovanna_Neri');
INSERT INTO PRESTITO VALUES (6, 'L6', 'Giovanna_Neri');
INSERT INTO PRESTITO VALUES (7, 'L3', 'Anna_Verdi');
INSERT INTO PRESTITO VALUES (8, 'L2', 'Anna_Verdi');


/* ESERCIZIO 1

Aggiungere alla table PRESTITO la    FOREIGN KEY (ISBN) REFERENCES LIBRI in modo tale che
(importante: le due istruzioni devono essere eseguite singolarmente nell'ordine dato)

DELETE FROM LIBRO WHERE ISBN='L6' 

-- NON DEVE ESSERE CONSENTITA SE IN PRESTITO CI SONO TUPLE CON 'L6'

UPDATE LIBRO SET ISBN= '_' + ISBN  WHERE ISBN='L6' 

-- MODIFICHI L'ISBN NEI RELATIVI PRESTITO IN SCRIVE
*/


ALTER TABLE PRESTITO
ADD CONSTRAINT FK_TO_LIBRO
FOREIGN KEY (ISBN) REFERENCES LIBRO
ON DELETE NO ACTION
ON UPDATE CASCADE

DELETE FROM LIBRO WHERE ISBN='L6' 

UPDATE LIBRO SET ISBN= '_' + ISBN  WHERE ISBN='L6' 

SELECT * 
FROM LIBRO;

SELECT*
FROM PRESTITO;


/*
ESERCIZIO 2
Selezionare gli utenti (tutti gli attributi) che hanno preso in prestito almeno un libro scritto da almeno un autore di Roma (RM)
*/

SELECT P.ISBN, P.NumeroPrestito, P.UTENTE
FROM PRESTITO P, LIBRO L, SCRIVE S, AUTORE A
WHERE P.ISBN = L.ISBN
AND   L.ISBN = S.ISBN
AND   S.COGNOME_AUTORE = A.COGNOME
AND   S.NOME_AUTORE = A.NOME
AND   A.CITTA = 'RM';


/*
ESERCIZIO 3
Selezionare gli utenti (tutti gli attributi) che hanno preso in prestito almeno un libro scritto da almeno due autori di Milano (MI)
*/

SELECT DISTINCT P.UTENTE
FROM PRESTITO P, SCRIVE S, AUTORE A
WHERE P.ISBN = S.ISBN
AND   S.COGNOME_AUTORE = A.COGNOME
AND   S.NOME_AUTORE = A.NOME
AND   CITTA = 'MI'
GROUP BY P.UTENTE, P.ISBN, P.NumeroPrestito
HAVING COUNT(*) >= 2; 


/*
ESERCIZIO 4
Selezionare gli utenti (tutti gli attributi) che non hanno mai preso in prestito  un libro scritto da almeno due autori di Milano (MI)
*/

SELECT DISTINCT UTENTE 
FROM PRESTITO P1
WHERE P1.UTENTE NOT IN (SELECT P2.UTENTE
					 FROM PRESTITO P2, SCRIVE S, AUTORE A
					 WHERE P2.ISBN = S.ISBN
					 AND   S.COGNOME_AUTORE = A.COGNOME
					 AND   S.NOME_AUTORE = A.NOME
					 AND   CITTA = 'MI'
					 GROUP BY P2.UTENTE, P2.ISBN, P2.NumeroPrestito
					 HAVING COUNT(*) >= 2); 
					 